## 동시성 이슈 보고서
> 쿠폰 발급 시 발생하는 동시성 이슈 분석

### 1. 문제 식별
> 동일한 사용자가 같은 쿠폰을 여러번 발급 시 동시성 문제 발생

### 2. 분석
> 사용자가 쿠폰 발급 시도 시
> - 테스트 코드에서 스레드에 빠지도록 하여 데드락 발생
> ```console
>  2025-04-20T01:11:05.018Z  WARN 12656 --- [hhplus] [pool-2-thread-3] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 1213, SQLState: 40001
>  2025-04-20T01:11:05.018Z  WARN 12656 --- [hhplus] [pool-2-thread-2] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 1213, SQLState: 40001
>  2025-04-20T01:11:05.018Z ERROR 12656 --- [hhplus] [pool-2-thread-3] o.h.engine.jdbc.spi.SqlExceptionHelper   : Deadlock found when trying to get lock; try restarting transaction
>  2025-04-20T01:11:05.018Z ERROR 12656 --- [hhplus] [pool-2-thread-2] o.h.engine.jdbc.spi.SqlExceptionHelper   : Deadlock found when trying to get lock; try restarting transaction
>  2025-04-20T01:11:05.028Z ERROR 12656 --- [hhplus] [pool-2-thread-3] k.h.b.s.a.c.CouponServiceSyncFailTest    : class org.springframework.dao.CannotAcquireLockException (error message: could not execute statement [Deadlock found when trying to get lock; try restarting transaction] [update coupons set discount_amount=?,expired_at=?,name=?,stock=? where id=?]; SQL [update coupons set discount_amount=?,expired_at=?,name=?,stock=? where id=?])
>  2025-04-20T01:11:05.028Z ERROR 12656 --- [hhplus] [pool-2-thread-2] k.h.b.s.a.c.CouponServiceSyncFailTest    : class org.springframework.dao.CannotAcquireLockException (error message: could not execute statement [Deadlock found when trying to get lock; try restarting transaction] [update coupons set discount_amount=?,expired_at=?,name=?,stock=? where id=?]; SQL [update coupons set discount_amount=?,expired_at=?,name=?,stock=? where id=?])
> ```

### 3. 해결
> - 쿠폰 조회 시 `select ~ for update` 쿼리로 배타 락 적용
>   - 쿠폰 발급 트랜잭션 안에서 락을 걸고 읽는다.
>   - 사용자가 쿠폰을 발급했는지 확인한 후 발급 처리를 한다.
> - 비관적 락 선택 이유
>   - 쿠폰 발급은 충돌이 많이 발생
>     - 낙관적 락 적용 시 충돌 발생 때마다 재시도 필요
>     - 서버 스레드, DB 커넥션 소모가 많을 것으로 예상
>   - 쿠폰 발급은 **한정 수량**
>     - **데이터 무결성**이 최우선이라고 생각

### 4. 대안 
> - 낙관적 락
>   - 쿠폰 엔티티에 value 필드 추가 및 `@Value` 적용
>   - 트래픽이 몰리는 **쿠폰 발급** 기능에서는 충돌이 자주 발생할 것으로 예상되고 충돌 발생 시마다 재시도 처리 필요
>   - 서버 스레드, DB 커넥션 소모가 많을 것으로 예상
> - `@Synchronized`
>   - 단일 서버인 경우 적용 가능
>   - 임시로 빠르게 구현이 필요한 경우 사용

---
---

### 1. 문제 식별
> 상품 재고 감소 시 너무 많은 트랜잭션이 발생할 경우 동시성 문제 발생

### 2. 분석
> 상품 재고 감소 시에 동시성 문제가 발생할 경우 예상되는 재고 차감이 안될 수 있다.

### 3. 해결
> 트랜잭션이 많이 발생하더라도 상품 재고 감소 시에 재시도 처리하도록 한다. 

### 4. 대안
> - 낙관적 락 적용
>   - 낙관적 락이 적용될 수 있도록 @Value 필드 추가 및 해당 메소드에 @Retryable 를 적용한다.
